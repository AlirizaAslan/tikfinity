{% extends 'tiktok_live/tikfinity_layout.html' %}
{% load static %}

{% block title %}User & Points - TikFinity{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn3.devexpress.com/jslib/23.1.5/css/dx.light.css" />
<style>
.page {
    padding: 20px;
}

.blueheading {
    color: #007acc;
    font-size: 24px;
    margin-bottom: 15px;
    font-weight: 600;
}

.setupUnconnected {
    margin: 20px 0;
}

.redNotification {
    background-color: #ff4444;
    color: white;
    padding: 15px;
    border-radius: 5px;
    cursor: pointer;
}

.usergrid-container {
    margin-top: 20px;
}

.gridUsernameCell {
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
}

.gridUsernameCell img {
    width: 32px;
    height: 32px;
    border-radius: 50%;
}

.currentPointsSystemCurrentUserCount {
    font-weight: bold;
    color: #007acc;
}

.currentPointsSystemMaxUserCount {
    font-weight: bold;
    color: #007acc;
}

.points-settings {
    background: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.settings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.setting-item {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.setting-item label {
    font-weight: 500;
    color: #333;
}

.setting-item input {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 4px;
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
}

.btn-primary {
    background-color: #007acc;
    color: white;
}

.btn-danger {
    background-color: #dc3545;
    color: white;
}

.btn:hover {
    opacity: 0.9;
}

.stats-row {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.stat-card {
    background: white;
    padding: 15px;
    border-radius: 8px;
    border: 1px solid #e0e0e0;
    min-width: 150px;
}

.stat-value {
    font-size: 24px;
    font-weight: bold;
    color: #007acc;
}

.stat-label {
    color: #666;
    font-size: 14px;
}
</style>
{% endblock %}

{% block content %}
<div class="page pageenabled" data-pageid="user">
    <h2 class="blueheading" data-str="user_head">User & Points</h2>
    <div data-str="user_desc">
        Here you can see a list of users including points, levels and other info. You have 
        <span class="currentPointsSystemCurrentUserCount">{{ total_users }}</span> of max 
        <span class="currentPointsSystemMaxUserCount">{{ max_users }}</span> users in your database.<br>
        Visit the <a href="#pointsSystemSettings" onclick="scrollToElement('#pointsSystemSettings')">Points System Settings</a> 
        to define for what your viewers receive points. To clear your database visit the 
        <a href="#resetPoints" onclick="scrollToElement('#resetPoints')">Reset Points Options</a>.
    </div>

    <div class="setupUnconnected" style="display: none;">
        <br>
        <div class="redNotification" style="cursor: pointer;" onclick="window.location.href='{% url 'tiktok_live:setup' %}'">
            <div class="error" data-str="start_setup_required">
                Please run the <a href="{% url 'tiktok_live:setup' %}">Setup</a> first to create a free TikFinity Account!
            </div>
        </div>
        <br>
    </div>

    <!-- Stats Row -->
    <div class="stats-row">
        <div class="stat-card">
            <div class="stat-value">{{ total_users }}</div>
            <div class="stat-label">Total Users</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ max_users }}</div>
            <div class="stat-label">Max Users</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="totalPoints">0</div>
            <div class="stat-label">Total Points</div>
        </div>
    </div>

    <!-- Points System Settings -->
    <div id="pointsSystemSettings" class="points-settings">
        <h3>Points System Settings</h3>
        <div class="settings-grid">
            <div class="setting-item">
                <label>Max Users</label>
                <input type="number" id="maxUsers" value="{{ points_settings.max_users }}" min="1" max="10000">
            </div>
            <div class="setting-item">
                <label>Points per Gift</label>
                <input type="number" id="pointsPerGift" value="{{ points_settings.points_per_gift }}" min="0">
            </div>
            <div class="setting-item">
                <label>Points per Follow</label>
                <input type="number" id="pointsPerFollow" value="{{ points_settings.points_per_follow }}" min="0">
            </div>
            <div class="setting-item">
                <label>Points per Like</label>
                <input type="number" id="pointsPerLike" value="{{ points_settings.points_per_like }}" min="0">
            </div>
            <div class="setting-item">
                <label>Points per Comment</label>
                <input type="number" id="pointsPerComment" value="{{ points_settings.points_per_comment }}" min="0">
            </div>
            <div class="setting-item">
                <label>Points per Share</label>
                <input type="number" id="pointsPerShare" value="{{ points_settings.points_per_share }}" min="0">
            </div>
            <div class="setting-item">
                <label>Level Up Threshold</label>
                <input type="number" id="levelUpThreshold" value="{{ points_settings.level_up_threshold }}" min="1">
            </div>
            <div class="setting-item">
                <label>
                    <input type="checkbox" id="enablePointsSystem" {% if points_settings.enable_points_system %}checked{% endif %}>
                    Enable Points System
                </label>
            </div>
        </div>
        <button class="btn btn-primary" onclick="updatePointsSettings()">Save Settings</button>
    </div>

    <!-- Reset Points Options -->
    <div id="resetPoints" class="points-settings">
        <h3>Reset Points Options</h3>
        <p>Warning: These actions cannot be undone!</p>
        <button class="btn btn-danger" onclick="resetPoints('points_only')">Reset All Points to 0</button>
        <button class="btn btn-danger" onclick="resetPoints('all')" style="margin-left: 10px;">Delete All User Data</button>
    </div>

    <!-- Users Data Grid -->
    <div class="dx-viewport">
        <div class="usergrid-container">
            <div id="dataGridUser"></div>
        </div>
    </div>
</div>

<!-- User Audit Modal -->
<div id="userAuditModal" style="display: none;">
    <div style="background: white; padding: 20px; border-radius: 8px; max-width: 600px; margin: 50px auto;">
        <h3>User Audit</h3>
        <div id="auditContent"></div>
        <button onclick="closeAuditModal()">Close</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn3.devexpress.com/jslib/23.1.5/js/dx.all.js"></script>
<script>
$(document).ready(function() {
    // Initialize DevExtreme DataGrid
    $("#dataGridUser").dxDataGrid({
        dataSource: {
            store: {
                type: "custom",
                key: "id",
                load: function(loadOptions) {
                    var params = {};
                    
                    // Sorting
                    if (loadOptions.sort) {
                        params.sort = loadOptions.sort[0].selector;
                        params.order = loadOptions.sort[0].desc ? 'desc' : 'asc';
                    }
                    
                    // Filtering
                    if (loadOptions.filter) {
                        // Handle filters - simplified for this example
                        var filters = loadOptions.filter;
                        if (Array.isArray(filters) && filters.length >= 3) {
                            var field = filters[0];
                            var operator = filters[1];
                            var value = filters[2];
                            
                            if (field === 'username' && operator === 'contains') {
                                params.username = value;
                            } else if (field === 'points_total' && operator === '=') {
                                params.points = value;
                            } else if (field === 'points_level' && operator === '=') {
                                params.level_points = value;
                            }
                        }
                    }
                    
                    return $.ajax({
                        url: "{% url 'tiktok_live:users_points_data' %}",
                        data: params,
                        dataType: "json"
                    }).then(function(result) {
                        return {
                            data: result.data,
                            totalCount: result.totalCount
                        };
                    });
                }
            }
        },
        remoteOperations: {
            sorting: true,
            filtering: true,
            paging: true
        },
        showBorders: true,
        showRowLines: true,
        showColumnLines: true,
        rowAlternationEnabled: false,
        columnAutoWidth: true,
        height: "calc(-160px + 100vh)",
        paging: {
            pageSize: 40
        },
        pager: {
            showPageSizeSelector: true,
            allowedPageSizes: [20, 40, 100],
            showInfo: true
        },
        filterRow: {
            visible: true
        },
        headerFilter: {
            visible: true
        },
        sorting: {
            mode: "single"
        },
        columns: [
            {
                dataField: "username",
                caption: "User",
                allowSorting: true,
                allowFiltering: true,
                cellTemplate: function(container, options) {
                    var userData = options.data;
                    var cellHtml = '<div class="gridUsernameCell" onclick="useraudit.resolveAndOpenAudit(\'' + userData.id + '\')">' +
                        '<div><img src="' + userData.profile_picture + '" onerror="this.src=\'/img/nothumb.webp\'" style="border-radius: 50%;"></div>' +
                        '<div>@' + userData.username + '</div>' +
                        '</div>';
                    container.html(cellHtml);
                }
            },
            {
                dataField: "level",
                caption: "Level",
                allowSorting: false,
                allowFiltering: false,
                width: 80
            },
            {
                dataField: "points_total",
                caption: "Points Total",
                allowSorting: true,
                allowFiltering: true,
                dataType: "number"
            },
            {
                dataField: "points_level",
                caption: "Points counted towards the level",
                allowSorting: true,
                allowFiltering: true,
                dataType: "number"
            },
            {
                dataField: "first_activity",
                caption: "First activity",
                allowSorting: true,
                allowFiltering: true,
                dataType: "datetime",
                format: "M/d/yyyy, h:mm a"
            },
            {
                dataField: "last_activity",
                caption: "Last activity",
                allowSorting: true,
                allowFiltering: true,
                dataType: "datetime",
                format: "M/d/yyyy, h:mm a"
            }
        ]
    });
});

// User audit functionality
var useraudit = {
    resolveAndOpenAudit: function(userId) {
        $.ajax({
            url: "{% url 'tiktok_live:user_audit' user_id=0 %}".replace('0', userId),
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    showUserAudit(response.user, response.transactions);
                } else {
                    alert('Error loading user audit: ' + response.error);
                }
            },
            error: function() {
                alert('Error loading user audit');
            }
        });
    }
};

function showUserAudit(user, transactions) {
    var content = '<h4>@' + user.username + '</h4>';
    content += '<p><strong>Level:</strong> ' + user.level + '</p>';
    content += '<p><strong>Total Points:</strong> ' + user.points_total + '</p>';
    content += '<p><strong>Level Points:</strong> ' + user.points_level + '</p>';
    
    content += '<h5>Recent Transactions</h5>';
    content += '<table style="width: 100%; border-collapse: collapse;">';
    content += '<tr><th>Type</th><th>Points</th><th>Description</th><th>Date</th></tr>';
    
    transactions.forEach(function(transaction) {
        content += '<tr>';
        content += '<td>' + transaction.type + '</td>';
        content += '<td>' + (transaction.points_change > 0 ? '+' : '') + transaction.points_change + '</td>';
        content += '<td>' + transaction.description + '</td>';
        content += '<td>' + transaction.created_at + '</td>';
        content += '</tr>';
    });
    
    content += '</table>';
    
    $('#auditContent').html(content);
    $('#userAuditModal').show();
}

function closeAuditModal() {
    $('#userAuditModal').hide();
}

// Settings functions
function updatePointsSettings() {
    var settings = {
        max_users: parseInt($('#maxUsers').val()),
        points_per_gift: parseInt($('#pointsPerGift').val()),
        points_per_follow: parseInt($('#pointsPerFollow').val()),
        points_per_like: parseInt($('#pointsPerLike').val()),
        points_per_comment: parseInt($('#pointsPerComment').val()),
        points_per_share: parseInt($('#pointsPerShare').val()),
        level_up_threshold: parseInt($('#levelUpThreshold').val()),
        enable_points_system: $('#enablePointsSystem').is(':checked')
    };
    
    $.ajax({
        url: "{% url 'tiktok_live:update_points_settings' %}",
        method: 'POST',
        data: JSON.stringify(settings),
        contentType: 'application/json',
        headers: {
            'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
        },
        success: function(response) {
            if (response.success) {
                alert('Settings updated successfully!');
            } else {
                alert('Error: ' + response.error);
            }
        },
        error: function() {
            alert('Error updating settings');
        }
    });
}

function resetPoints(type) {
    var message = type === 'all' ? 
        'Are you sure you want to delete ALL user data? This cannot be undone!' :
        'Are you sure you want to reset all points to 0? This cannot be undone!';
    
    if (confirm(message)) {
        $.ajax({
            url: "{% url 'tiktok_live:reset_points' %}",
            method: 'POST',
            data: JSON.stringify({type: type}),
            contentType: 'application/json',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val()
            },
            success: function(response) {
                if (response.success) {
                    alert(response.message);
                    location.reload();
                } else {
                    alert('Error: ' + response.error);
                }
            },
            error: function() {
                alert('Error resetting points');
            }
        });
    }
}

function scrollToElement(selector) {
    $(selector)[0].scrollIntoView({behavior: 'smooth'});
}

// Navigation helper
var navigation = {
    pageChange: function(page) {
        // Handle page navigation if needed
        console.log('Navigate to:', page);
    },
    scrollToPageElement: function(page, element) {
        scrollToElement(element);
    }
};
</script>
{% endblock %}