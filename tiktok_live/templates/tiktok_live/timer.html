{% extends 'tiktok_live/tikfinity_layout.html' %}

{% block title %}Timer - TikFinity{% endblock %}

{% block content %}
<div class="desktopAppPromotion" style="display: block;">
    <div class="promotion-content">
        Get the free <a href="/app/">TikFinity Desktop App</a> for Windows to enjoy additional features and stability improvements!
    </div>
</div>

<h2 class="blueheading">Timer</h2>
<div>
    Here you can create a countdown that can be controlled by your viewers.<br>
    Viewers can extend or shorten the countdown through interactions to decide how long you have to stream.<br>
    Watch <a href="https://www.youtube.com/watch?v=363AX0F6VPY" target="_blank">this tutorial</a> to learn how to set up a subathon timer.<br>
</div>
<br>

{% if not_authenticated %}
<div class="redNotification">
    <div class="error">Please <a href="{% url 'tiktok_live:login' %}">login</a> to use the Timer feature!</div>
</div>
<br>
{% else %}

<div class="greyBackgroundSection greyBackgroundSectionDynamicWidth">
    <h3 class="blueheading noTopMarginHeader">Overlay</h3>
    <div style="display: table-row;">
        <div style="display: table-cell;">
            <input type="text" readonly value="{{ widget_url }}" style="width: 501px; padding: 8px; border: 1px solid #4e4e4e; background: #2a2a2a; color: #fff;">
        </div>
        <div style="display: table-cell; padding-left: 5px;">
            <button onclick="copyWidgetUrl()" style="width: 105px; margin-bottom: 2px; padding: 8px; background: #0095f6; color: white; border: none; cursor: pointer;">Copy URL</button>
        </div>
        <div style="display: table-cell; padding-left: 4px;">
            <button disabled style="width: 100px; margin-bottom: 2px; padding: 8px; background: #555; color: #999; border: none;">Test</button>
        </div>
        <div style="display: table-cell; padding-left: 4px;">
            <button style="width: 150px; margin-bottom: 2px; padding: 8px; background: #0095f6; color: white; border: none; cursor: pointer;">Customize</button>
        </div>
    </div>
    <iframe src="{{ widget_url }}&preview=1" allow="autoplay" style="width: 867px; height: 120px; margin-top: 4px; border: 1px solid #4e4e4e;"></iframe>
</div>

<div class="greyBackgroundSection greyBackgroundSectionDynamicWidth" style="min-width: 869px;">
    <h3 class="blueheading noTopMarginHeader">Control</h3>
    <table>
        <tr>
            <td><button id="btnStart" onclick="timerStart()" style="width: 150px; padding: 10px; background: #0095f6; color: white; border: none; cursor: pointer; margin-right: 5px;"><i class="fas fa-play"></i> Start</button></td>
            <td><button id="btnPause" onclick="timerPause()" disabled style="width: 150px; padding: 10px; background: #555; color: #999; border: none; margin-right: 5px;"><i class="fas fa-pause"></i> Pause</button></td>
            <td><button id="btnReset" onclick="timerReset()" disabled style="width: 150px; padding: 10px; background: #555; color: #999; border: none; margin-right: 5px;"><i class="fas fa-undo"></i> Reset</button></td>
            <td></td>
            <td><input type="number" id="manualTime" value="10" min="1" max="14400" step="1" disabled style="width: 100px; padding: 8px; background: #2a2a2a; color: #fff; border: 1px solid #4e4e4e;"></td>
            <td><button id="btnAdd" onclick="timerAddManual()" disabled style="padding: 10px; background: #555; color: #999; border: none; margin: 0 2px;"><i class="fas fa-plus"></i></button></td>
            <td><button id="btnSubtract" onclick="timerSubtractManual()" disabled style="padding: 10px; background: #555; color: #999; border: none; margin: 0 2px;"><i class="fas fa-minus"></i></button></td>
        </tr>
    </table>
    <br>
</div>

<table>
    <tr>
        <td>
            <div class="greyBackgroundSection greyBackgroundSectionDynamicWidth" style="height: 700px;">
                <h3 class="blueheading noTopMarginHeader">Settings</h3>
                
                <div class="dxForm">
                    <div class="form">
                        <div class="dx-fieldset">
                            <div class="dx-field">
                                <div class="dx-field-label">Default Start Value</div>
                                <div class="dx-field-value">
                                    <input type="number" id="defaultStartValue" value="{{ countdown_timer.default_start_value }}" min="1" max="14400" step="1" style="width: 200px; padding: 8px; background: #2a2a2a; color: #fff; border: 1px solid #4e4e4e;">
                                </div>
                            </div>
                            <div class="dx-field">
                                <div class="dx-field-label">Action on expiry</div>
                                <div class="dx-field-value dxFieldValueFix">
                                    <b class="timerExpireActionName">{{ countdown_timer.get_expire_action_display }}</b> <a onclick="changeExpireAction()" style="cursor: pointer; color: #0095f6;">Change</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <br>
                
                <div>
                    Define by how many seconds the timer increases or decreases for each interaction type.<br>
                    Use positive values to increase the timer and negative values (e.g. -5) to decrease the timer.<br>
                    You can also use decimal numbers e.g. 0.05 if a full second is too much.
                </div>
                
                <div>
                    <div class="dxForm">
                        <div class="form">
                            <div class="dx-fieldset">
                                <div class="dx-field">
                                    <div class="dx-field-label">Per Coin</div>
                                    <div class="dx-field-value">
                                        <input type="number" id="secondsPerCoin" value="{{ countdown_timer.seconds_per_coin }}" min="-100000" max="100000" step="1" style="width: 200px; padding: 8px; background: #2a2a2a; color: #fff; border: 1px solid #4e4e4e;">
                                    </div>
                                </div>
                                <div class="dx-field">
                                    <div class="dx-field-label">Per Subscribe / Super Fan</div>
                                    <div class="dx-field-value">
                                        <input type="number" id="secondsPerSubscribe" value="{{ countdown_timer.seconds_per_subscribe }}" min="-100000" max="100000" step="1" style="width: 200px; padding: 8px; background: #2a2a2a; color: #fff; border: 1px solid #4e4e4e;">
                                    </div>
                                </div>
                                <div class="dx-field">
                                    <div class="dx-field-label">Per Follow</div>
                                    <div class="dx-field-value">
                                        <input type="number" id="secondsPerFollow" value="{{ countdown_timer.seconds_per_follow }}" min="-100000" max="100000" step="1" style="width: 200px; padding: 8px; background: #2a2a2a; color: #fff; border: 1px solid #4e4e4e;">
                                    </div>
                                </div>
                                <div class="dx-field">
                                    <div class="dx-field-label">Per Share</div>
                                    <div class="dx-field-value">
                                        <input type="number" id="secondsPerShare" value="{{ countdown_timer.seconds_per_share }}" min="-100000" max="100000" step="1" style="width: 200px; padding: 8px; background: #2a2a2a; color: #fff; border: 1px solid #4e4e4e;">
                                    </div>
                                </div>
                                <div class="dx-field">
                                    <div class="dx-field-label">Per Like</div>
                                    <div class="dx-field-value">
                                        <input type="number" id="secondsPerLike" value="{{ countdown_timer.seconds_per_like }}" min="-100000" max="100000" step="1" style="width: 200px; padding: 8px; background: #2a2a2a; color: #fff; border: 1px solid #4e4e4e;">
                                    </div>
                                </div>
                                <div class="dx-field">
                                    <div class="dx-field-label">Per Chat Message</div>
                                    <div class="dx-field-value">
                                        <input type="number" id="secondsPerChat" value="{{ countdown_timer.seconds_per_chat }}" min="-100000" max="100000" step="1" style="width: 200px; padding: 8px; background: #2a2a2a; color: #fff; border: 1px solid #4e4e4e;">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div>
                    <div class="dxForm">
                        <div class="form">
                            <div class="dx-fieldset">
                                <div class="dx-field">
                                    <div class="dx-field-label">
                                        <input type="checkbox" id="enableMultiplier" {% if countdown_timer.enable_multiplier %}checked{% endif %} onchange="toggleMultiplier()"> Activate Multiplier
                                    </div>
                                    <div class="dx-field-value">
                                        <input type="number" id="multiplierValue" value="{{ countdown_timer.multiplier_value }}" min="0.5" max="100" step="0.5" {% if not countdown_timer.enable_multiplier %}disabled{% endif %} style="width: 200px; padding: 8px; background: #2a2a2a; color: #fff; border: 1px solid #4e4e4e;">
                                        <br><small>If activated, all configured values are multiplied by the multiplier.</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <br>
                <button onclick="saveSettings()" style="padding: 10px 20px; background: #0095f6; color: white; border: none; cursor: pointer;">Save Settings</button>
            </div>
        </td>
        
        <td>
            <div class="greyBackgroundSection greyBackgroundSectionDynamicWidth" style="height: 700px;">
                <h3 class="blueheading noTopMarginHeader">Keyboard Shortcuts</h3>
                <br>
                
                <h4>Start / Pause</h4>
                <input type="text" id="shortcutStartPause" value="{{ countdown_timer.shortcut_start_pause }}" placeholder="Not Set" style="width: 250px; padding: 8px; background: #2a2a2a; color: #fff; border: 1px solid #4e4e4e;">
                <br><br>
                
                <h4>Increase</h4>
                <input type="text" id="shortcutIncrease" value="{{ countdown_timer.shortcut_increase }}" placeholder="Not Set" style="width: 250px; padding: 8px; background: #2a2a2a; color: #fff; border: 1px solid #4e4e4e;">
                <br><br>
                
                <h4>Reduce</h4>
                <input type="text" id="shortcutReduce" value="{{ countdown_timer.shortcut_reduce }}" placeholder="Not Set" style="width: 250px; padding: 8px; background: #2a2a2a; color: #fff; border: 1px solid #4e4e4e;">
                <br><br>
                
                <h4>Increase / Reduce Step</h4>
                <input type="number" id="shortcutStep" value="{{ countdown_timer.shortcut_step }}" min="1" max="10000" step="1" style="width: 250px; padding: 8px; background: #2a2a2a; color: #fff; border: 1px solid #4e4e4e;">
                <br>
            </div>
        </td>
    </tr>
</table>

<script>
function copyWidgetUrl() {
    const url = "{{ widget_url }}";
    navigator.clipboard.writeText(url).then(() => {
        alert('Widget URL copied to clipboard!');
    });
}

function timerStart() {
    fetch("{% url 'tiktok_live:timer_start' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('btnStart').disabled = true;
            document.getElementById('btnPause').disabled = false;
            document.getElementById('btnReset').disabled = false;
            document.getElementById('manualTime').disabled = false;
            document.getElementById('btnAdd').disabled = false;
            document.getElementById('btnSubtract').disabled = false;
        }
    });
}

function timerPause() {
    fetch("{% url 'tiktok_live:timer_pause' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('btnStart').disabled = false;
            document.getElementById('btnPause').disabled = true;
        }
    });
}

function timerReset() {
    if (!confirm('Are you sure you want to reset the timer?')) return;
    
    fetch("{% url 'tiktok_live:timer_reset' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('btnStart').disabled = false;
            document.getElementById('btnPause').disabled = true;
            document.getElementById('btnReset').disabled = true;
            document.getElementById('manualTime').disabled = true;
            document.getElementById('btnAdd').disabled = true;
            document.getElementById('btnSubtract').disabled = true;
        }
    });
}

function timerAddManual() {
    const seconds = parseInt(document.getElementById('manualTime').value) * 60;
    
    fetch("{% url 'tiktok_live:timer_add_time' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ seconds: seconds })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
        }
    });
}

function timerSubtractManual() {
    const seconds = parseInt(document.getElementById('manualTime').value) * 60;
    
    fetch("{% url 'tiktok_live:timer_subtract_time' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ seconds: seconds })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
        }
    });
}

function toggleMultiplier() {
    const enabled = document.getElementById('enableMultiplier').checked;
    document.getElementById('multiplierValue').disabled = !enabled;
}

function saveSettings() {
    const settings = {
        default_start_value: parseInt(document.getElementById('defaultStartValue').value),
        seconds_per_coin: parseFloat(document.getElementById('secondsPerCoin').value),
        seconds_per_subscribe: parseFloat(document.getElementById('secondsPerSubscribe').value),
        seconds_per_follow: parseFloat(document.getElementById('secondsPerFollow').value),
        seconds_per_share: parseFloat(document.getElementById('secondsPerShare').value),
        seconds_per_like: parseFloat(document.getElementById('secondsPerLike').value),
        seconds_per_chat: parseFloat(document.getElementById('secondsPerChat').value),
        enable_multiplier: document.getElementById('enableMultiplier').checked,
        multiplier_value: parseFloat(document.getElementById('multiplierValue').value),
        shortcut_start_pause: document.getElementById('shortcutStartPause').value,
        shortcut_increase: document.getElementById('shortcutIncrease').value,
        shortcut_reduce: document.getElementById('shortcutReduce').value,
        shortcut_step: parseInt(document.getElementById('shortcutStep').value)
    };
    
    fetch("{% url 'tiktok_live:timer_update_settings' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify(settings)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Settings saved successfully!');
        } else {
            alert('Error: ' + data.error);
        }
    });
}

function changeExpireAction() {
    const action = prompt('Select action on expiry:\n1. Do Nothing\n2. End Stream\n3. Play Sound\n4. Show Message\n5. Trigger Action', '1');
    
    const actions = {
        '1': 'none',
        '2': 'end_stream',
        '3': 'play_sound',
        '4': 'show_message',
        '5': 'trigger_action'
    };
    
    if (action && actions[action]) {
        fetch("{% url 'tiktok_live:timer_set_expire_action' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ action: actions[action] })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            }
        });
    }
}
</script>
{% endif %}
{% endblock %}
