{% extends 'tiktok_live/base.html' %}

{% block title %}User & Points - TikFinity{% endblock %}

{% block extra_css %}
<style>
    .users-container { background: #1a1a1a; padding: 30px; border-radius: 12px; }
    .users-header { color: #667eea; font-size: 1.8em; margin-bottom: 10px; }
    .users-desc { color: #aaa; margin-bottom: 30px; line-height: 1.6; }
    .users-desc a { color: #667eea; text-decoration: underline; cursor: pointer; }
    .users-desc a:hover { color: #5568d3; }
    
    .user-stats { display: flex; gap: 20px; margin-bottom: 20px; }
    .stat-item { background: #252525; padding: 15px 20px; border-radius: 8px; text-align: center; }
    .stat-number { font-size: 1.5em; font-weight: bold; color: #10b981; }
    .stat-label { color: #aaa; font-size: 0.9em; margin-top: 5px; }
    
    .setup-warning { background: #dc2626; padding: 15px; border-radius: 8px; margin-bottom: 20px; cursor: pointer; display: none; }
    .setup-warning:hover { background: #b91c1c; }
    
    .users-table { width: 100%; background: #252525; border-radius: 8px; overflow: hidden; }
    .table-header { background: #1a1a1a; }
    .table-header th { padding: 15px; text-align: left; color: #ccc; font-weight: 500; border-bottom: 1px solid #333; position: relative; cursor: pointer; }
    .table-header th:hover { background: #2a2a2a; }
    .table-header th.sortable::after { content: '↕'; position: absolute; right: 10px; color: #666; }
    .table-header th.sort-asc::after { content: '↑'; color: #667eea; }
    .table-header th.sort-desc::after { content: '↓'; color: #667eea; }
    
    .table-filters { background: #2a2a2a; }
    .table-filters td { padding: 10px; border-bottom: 1px solid #333; }
    .filter-input { width: 100%; padding: 8px; background: #1a1a1a; border: 1px solid #333; color: #fff; border-radius: 4px; }
    .filter-input:focus { border-color: #667eea; outline: none; }
    
    .table-body tr { border-bottom: 1px solid #333; transition: background 0.2s; }
    .table-body tr:hover { background: #2a2a2a; }
    .table-body td { padding: 12px 15px; color: #fff; }
    
    .user-cell { display: flex; align-items: center; gap: 10px; cursor: pointer; }
    .user-avatar { width: 40px; height: 40px; border-radius: 50%; }
    .user-name { color: #fff; font-weight: 500; }
    .user-name:hover { color: #667eea; }
    
    .level-badge { background: linear-gradient(45deg, #667eea, #764ba2); padding: 4px 12px; border-radius: 20px; font-weight: bold; font-size: 0.9em; }
    
    .points-total { color: #10b981; font-weight: bold; }
    .points-level { color: #f59e0b; font-weight: 500; }
    
    .date-cell { color: #aaa; font-size: 0.9em; }
    
    .pagination { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }
    .pagination button { padding: 8px 12px; background: #333; border: none; color: #fff; border-radius: 4px; cursor: pointer; }
    .pagination button:hover { background: #444; }
    .pagination button.active { background: #667eea; }
    .pagination button:disabled { background: #222; color: #666; cursor: not-allowed; }
    
    .loading-indicator { text-align: center; padding: 20px; color: #aaa; }
    .loading-indicator img { width: 50px; height: 50px; }
    
    .no-data { text-align: center; padding: 40px; color: #666; }
    .no-data i { font-size: 3em; margin-bottom: 15px; }
    
    .export-controls { display: flex; gap: 10px; margin-bottom: 20px; }
    .btn-export { background: #10b981; padding: 10px 20px; border: none; border-radius: 6px; color: white; cursor: pointer; }
    .btn-export:hover { background: #059669; }
    .btn-refresh { background: #667eea; padding: 10px 20px; border: none; border-radius: 6px; color: white; cursor: pointer; }
    .btn-refresh:hover { background: #5568d3; }
</style>
{% endblock %}

{% block content %}
<div class="users-container">
    <h2 class="users-header">User & Points</h2>
    <div class="users-desc">
        Here you can see a list of users including points, levels and other info. You have 
        <span class="currentPointsSystemCurrentUserCount">67</span> of max 
        <span class="currentPointsSystemMaxUserCount">2,500</span> users in your database.<br>
        Visit the <a onclick="navigateToSetup('pointsSystemSettings')">Points System Settings</a> to define for what your viewers receive points. 
        To clear your database visit the <a onclick="navigateToSetup('resetPoints')">Reset Points Options</a>.
    </div>

    <!-- User Statistics -->
    <div class="user-stats">
        <div class="stat-item">
            <div class="stat-number" id="totalUsers">67</div>
            <div class="stat-label">Total Users</div>
        </div>
        <div class="stat-item">
            <div class="stat-number" id="activeUsers">23</div>
            <div class="stat-label">Active Today</div>
        </div>
        <div class="stat-item">
            <div class="stat-number" id="totalPoints">8,542</div>
            <div class="stat-label">Total Points</div>
        </div>
        <div class="stat-item">
            <div class="stat-number" id="avgLevel">6.2</div>
            <div class="stat-label">Average Level</div>
        </div>
    </div>

    <!-- Setup Warning -->
    <div class="setup-warning" id="setupWarning">
        <div>Please run the <a href="{% url 'tiktok_live:setup' %}" style="color: #fff; text-decoration: underline;">Setup</a> first to create a free TikFinity Account!</div>
    </div>

    <!-- Export Controls -->
    <div class="export-controls">
        <button class="btn-export" onclick="exportUsers('csv')">
            <i class="fas fa-download"></i> Export CSV
        </button>
        <button class="btn-export" onclick="exportUsers('json')">
            <i class="fas fa-file-code"></i> Export JSON
        </button>
        <button class="btn-refresh" onclick="refreshUserData()">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
    </div>

    <!-- Users Table -->
    <div class="users-table">
        <table style="width: 100%;">
            <thead class="table-header">
                <tr>
                    <th class="sortable" onclick="sortTable('user')" data-sort="user">User</th>
                    <th class="sortable" onclick="sortTable('level')" data-sort="level">Level</th>
                    <th class="sortable sort-desc" onclick="sortTable('points_total')" data-sort="points_total">Points Total</th>
                    <th class="sortable" onclick="sortTable('points_level')" data-sort="points_level">Points counted towards the level</th>
                    <th class="sortable" onclick="sortTable('first_activity')" data-sort="first_activity">First activity</th>
                    <th class="sortable" onclick="sortTable('last_activity')" data-sort="last_activity">Last activity</th>
                </tr>
            </thead>
            <tbody class="table-filters">
                <tr>
                    <td><input type="text" class="filter-input" placeholder="Filter users..." id="filterUser" oninput="filterUsers()"></td>
                    <td><input type="number" class="filter-input" placeholder="Level..." id="filterLevel" oninput="filterUsers()"></td>
                    <td><input type="number" class="filter-input" placeholder="Points..." id="filterPoints" oninput="filterUsers()"></td>
                    <td><input type="number" class="filter-input" placeholder="Level points..." id="filterLevelPoints" oninput="filterUsers()"></td>
                    <td><input type="date" class="filter-input" id="filterFirstActivity" onchange="filterUsers()"></td>
                    <td><input type="date" class="filter-input" id="filterLastActivity" onchange="filterUsers()"></td>
                </tr>
            </tbody>
            <tbody class="table-body" id="usersTableBody">
                <!-- Sample users data -->
                <tr data-user-id="307694277818540032">
                    <td>
                        <div class="user-cell" onclick="openUserAudit('307694277818540032')">
                            <img src="https://via.placeholder.com/40" class="user-avatar" onerror="this.src='https://via.placeholder.com/40'">
                            <span class="user-name">@user47474747474771</span>
                        </div>
                    </td>
                    <td><span class="level-badge">38</span></td>
                    <td><span class="points-total">1,739.50</span></td>
                    <td><span class="points-level">3,479.00</span></td>
                    <td><span class="date-cell">11/5/2025, 10:08 PM</span></td>
                    <td><span class="date-cell">11/5/2025, 10:14 PM</span></td>
                </tr>
                <tr data-user-id="7206829818121683973">
                    <td>
                        <div class="user-cell" onclick="openUserAudit('7206829818121683973')">
                            <img src="https://via.placeholder.com/40" class="user-avatar" onerror="this.src='https://via.placeholder.com/40'">
                            <span class="user-name">@savo.ofcl</span>
                        </div>
                    </td>
                    <td><span class="level-badge">18</span></td>
                    <td><span class="points-total">599.50</span></td>
                    <td><span class="points-level">1,199.00</span></td>
                    <td><span class="date-cell">11/5/2025, 10:29 PM</span></td>
                    <td><span class="date-cell">11/5/2025, 10:30 PM</span></td>
                </tr>
                <tr data-user-id="7515461382575621152">
                    <td>
                        <div class="user-cell" onclick="openUserAudit('7515461382575621152')">
                            <img src="https://via.placeholder.com/40" class="user-avatar" onerror="this.src='https://via.placeholder.com/40'">
                            <span class="user-name">@hakanantep2727</span>
                        </div>
                    </td>
                    <td><span class="level-badge">12</span></td>
                    <td><span class="points-total">344.50</span></td>
                    <td><span class="points-level">689.00</span></td>
                    <td><span class="date-cell">11/5/2025, 9:59 PM</span></td>
                    <td><span class="date-cell">11/5/2025, 10:10 PM</span></td>
                </tr>
                <tr data-user-id="6584346716425666566">
                    <td>
                        <div class="user-cell" onclick="openUserAudit('6584346716425666566')">
                            <img src="https://via.placeholder.com/40" class="user-avatar" onerror="this.src='https://via.placeholder.com/40'">
                            <span class="user-name">@ahmet.ahmt06</span>
                        </div>
                    </td>
                    <td><span class="level-badge">9</span></td>
                    <td><span class="points-total">235.00</span></td>
                    <td><span class="points-level">470.00</span></td>
                    <td><span class="date-cell">11/5/2025, 10:41 PM</span></td>
                    <td><span class="date-cell">11/5/2025, 10:45 PM</span></td>
                </tr>
                <tr data-user-id="7128418926451115013">
                    <td>
                        <div class="user-cell" onclick="openUserAudit('7128418926451115013')">
                            <img src="https://via.placeholder.com/40" class="user-avatar" onerror="this.src='https://via.placeholder.com/40'">
                            <span class="user-name">@justpoena</span>
                        </div>
                    </td>
                    <td><span class="level-badge">8</span></td>
                    <td><span class="points-total">205.00</span></td>
                    <td><span class="points-level">410.00</span></td>
                    <td><span class="date-cell">11/17/2025, 8:59 PM</span></td>
                    <td><span class="date-cell">11/17/2025, 9:02 PM</span></td>
                </tr>
            </tbody>
        </table>
        
        <!-- Loading Indicator -->
        <div class="loading-indicator" id="loadingIndicator" style="display: none;">
            <img src="https://via.placeholder.com/50x50/666/fff?text=..." alt="Loading">
            <div>Loading users...</div>
        </div>
        
        <!-- No Data Message -->
        <div class="no-data" id="noDataMessage" style="display: none;">
            <i class="fas fa-users"></i>
            <div>No users found matching your criteria</div>
        </div>
    </div>

    <!-- Pagination -->
    <div class="pagination" id="pagination">
        <button onclick="changePage('prev')" id="prevBtn"><i class="fas fa-chevron-left"></i></button>
        <button class="active" onclick="changePage(1)">1</button>
        <button onclick="changePage(2)">2</button>
        <button onclick="changePage(3)">3</button>
        <button onclick="changePage('next')" id="nextBtn"><i class="fas fa-chevron-right"></i></button>
    </div>
</div>

<script>
let currentPage = 1;
let totalPages = 3;
let currentSort = { column: 'points_total', direction: 'desc' };
let allUsers = [];

// Sample user data
const sampleUsers = [
    { id: '307694277818540032', username: '@user47474747474771', level: 38, pointsTotal: 1739.50, pointsLevel: 3479.00, firstActivity: '2025-11-05T22:08:00', lastActivity: '2025-11-05T22:14:00' },
    { id: '7206829818121683973', username: '@savo.ofcl', level: 18, pointsTotal: 599.50, pointsLevel: 1199.00, firstActivity: '2025-11-05T22:29:00', lastActivity: '2025-11-05T22:30:00' },
    { id: '7515461382575621152', username: '@hakanantep2727', level: 12, pointsTotal: 344.50, pointsLevel: 689.00, firstActivity: '2025-11-05T21:59:00', lastActivity: '2025-11-05T22:10:00' },
    { id: '6584346716425666566', username: '@ahmet.ahmt06', level: 9, pointsTotal: 235.00, pointsLevel: 470.00, firstActivity: '2025-11-05T22:41:00', lastActivity: '2025-11-05T22:45:00' },
    { id: '7128418926451115013', username: '@justpoena', level: 8, pointsTotal: 205.00, pointsLevel: 410.00, firstActivity: '2025-11-17T20:59:00', lastActivity: '2025-11-17T21:02:00' }
];

function navigateToSetup(section) {
    // Navigate to setup page and scroll to specific section
    window.location.href = `{% url 'tiktok_live:setup' %}#${section}`;
}

function openUserAudit(userId) {
    console.log('Opening user audit for:', userId);
    // Implement user audit functionality
    alert(`Opening audit for user: ${userId}`);
}

function sortTable(column) {
    const headers = document.querySelectorAll('.table-header th');
    headers.forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
    
    if (currentSort.column === column) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
    } else {
        currentSort.column = column;
        currentSort.direction = 'desc';
    }
    
    const header = document.querySelector(`[data-sort="${column}"]`);
    header.classList.add(currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc');
    
    // Sort and refresh table
    sortUsers();
    renderUsers();
}

function sortUsers() {
    allUsers.sort((a, b) => {
        let aVal, bVal;
        
        switch (currentSort.column) {
            case 'user':
                aVal = a.username.toLowerCase();
                bVal = b.username.toLowerCase();
                break;
            case 'level':
                aVal = a.level;
                bVal = b.level;
                break;
            case 'points_total':
                aVal = a.pointsTotal;
                bVal = b.pointsTotal;
                break;
            case 'points_level':
                aVal = a.pointsLevel;
                bVal = b.pointsLevel;
                break;
            case 'first_activity':
                aVal = new Date(a.firstActivity);
                bVal = new Date(b.firstActivity);
                break;
            case 'last_activity':
                aVal = new Date(a.lastActivity);
                bVal = b.lastActivity;
                break;
            default:
                return 0;
        }
        
        if (currentSort.direction === 'asc') {
            return aVal > bVal ? 1 : -1;
        } else {
            return aVal < bVal ? 1 : -1;
        }
    });
}

function filterUsers() {
    const userFilter = document.getElementById('filterUser').value.toLowerCase();
    const levelFilter = document.getElementById('filterLevel').value;
    const pointsFilter = document.getElementById('filterPoints').value;
    const levelPointsFilter = document.getElementById('filterLevelPoints').value;
    const firstActivityFilter = document.getElementById('filterFirstActivity').value;
    const lastActivityFilter = document.getElementById('filterLastActivity').value;
    
    const rows = document.querySelectorAll('#usersTableBody tr');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const username = cells[0].textContent.toLowerCase();
        const level = cells[1].textContent;
        const points = cells[2].textContent.replace(/[^\d.]/g, '');
        const levelPoints = cells[3].textContent.replace(/[^\d.]/g, '');
        
        let show = true;
        
        if (userFilter && !username.includes(userFilter)) show = false;
        if (levelFilter && !level.includes(levelFilter)) show = false;
        if (pointsFilter && !points.includes(pointsFilter)) show = false;
        if (levelPointsFilter && !levelPoints.includes(levelPointsFilter)) show = false;
        
        row.style.display = show ? '' : 'none';
        if (show) visibleCount++;
    });
    
    // Show/hide no data message
    document.getElementById('noDataMessage').style.display = visibleCount === 0 ? 'block' : 'none';
}

function renderUsers() {
    const tbody = document.getElementById('usersTableBody');
    tbody.innerHTML = '';
    
    allUsers.forEach(user => {
        const row = document.createElement('tr');
        row.setAttribute('data-user-id', user.id);
        row.innerHTML = `
            <td>
                <div class="user-cell" onclick="openUserAudit('${user.id}')">
                    <img src="https://via.placeholder.com/40" class="user-avatar" onerror="this.src='https://via.placeholder.com/40'">
                    <span class="user-name">${user.username}</span>
                </div>
            </td>
            <td><span class="level-badge">${user.level}</span></td>
            <td><span class="points-total">${user.pointsTotal.toLocaleString()}</span></td>
            <td><span class="points-level">${user.pointsLevel.toLocaleString()}</span></td>
            <td><span class="date-cell">${new Date(user.firstActivity).toLocaleString()}</span></td>
            <td><span class="date-cell">${new Date(user.lastActivity).toLocaleString()}</span></td>
        `;
        tbody.appendChild(row);
    });
}

function changePage(page) {
    if (page === 'prev' && currentPage > 1) {
        currentPage--;
    } else if (page === 'next' && currentPage < totalPages) {
        currentPage++;
    } else if (typeof page === 'number') {
        currentPage = page;
    }
    
    // Update pagination buttons
    document.querySelectorAll('.pagination button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    const pageButtons = document.querySelectorAll('.pagination button:not(#prevBtn):not(#nextBtn)');
    if (pageButtons[currentPage - 1]) {
        pageButtons[currentPage - 1].classList.add('active');
    }
    
    // Update prev/next button states
    document.getElementById('prevBtn').disabled = currentPage === 1;
    document.getElementById('nextBtn').disabled = currentPage === totalPages;
    
    console.log('Loading page:', currentPage);
}

function refreshUserData() {
    const loadingIndicator = document.getElementById('loadingIndicator');
    loadingIndicator.style.display = 'block';
    
    // Simulate API call
    setTimeout(() => {
        loadingIndicator.style.display = 'none';
        console.log('User data refreshed');
    }, 1000);
}

function exportUsers(format) {
    console.log(`Exporting users in ${format} format`);
    
    if (format === 'csv') {
        // Generate CSV
        let csv = 'Username,Level,Points Total,Points Level,First Activity,Last Activity\n';
        allUsers.forEach(user => {
            csv += `${user.username},${user.level},${user.pointsTotal},${user.pointsLevel},${user.firstActivity},${user.lastActivity}\n`;
        });
        
        // Download CSV
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'users_export.csv';
        a.click();
        window.URL.revokeObjectURL(url);
    } else if (format === 'json') {
        // Download JSON
        const blob = new Blob([JSON.stringify(allUsers, null, 2)], { type: 'application/json' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'users_export.json';
        a.click();
        window.URL.revokeObjectURL(url);
    }
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    allUsers = [...sampleUsers];
    sortUsers();
    renderUsers();
    
    // Check connection status
    const isConnected = Math.random() > 0.3; // Random for demo
    if (!isConnected) {
        document.getElementById('setupWarning').style.display = 'block';
    }
    
    // Update statistics
    updateStatistics();
});

function updateStatistics() {
    const totalUsers = allUsers.length;
    const activeUsers = Math.floor(totalUsers * 0.4); // 40% active
    const totalPoints = allUsers.reduce((sum, user) => sum + user.pointsTotal, 0);
    const avgLevel = totalUsers > 0 ? (allUsers.reduce((sum, user) => sum + user.level, 0) / totalUsers).toFixed(1) : 0;
    
    document.getElementById('totalUsers').textContent = totalUsers;
    document.getElementById('activeUsers').textContent = activeUsers;
    document.getElementById('totalPoints').textContent = totalPoints.toLocaleString();
    document.getElementById('avgLevel').textContent = avgLevel;
}
</script>
{% endblock %}