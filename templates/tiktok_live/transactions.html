{% extends 'tiktok_live/base.html' %}

{% block title %}Transactions - TikFinity{% endblock %}

{% block extra_css %}
<style>
    .transactions-container { background: #1a1a1a; padding: 30px; border-radius: 12px; }
    .transactions-header { color: #667eea; font-size: 1.8em; margin-bottom: 10px; }
    .transactions-desc { color: #aaa; margin-bottom: 30px; line-height: 1.6; }
    
    .setup-warning { background: #dc2626; padding: 15px; border-radius: 8px; margin-bottom: 20px; cursor: pointer; }
    .setup-warning:hover { background: #b91c1c; }
    
    .controls-section { display: flex; gap: 15px; margin-bottom: 30px; }
    .btn-add { background: #667eea; padding: 12px 24px; border: none; border-radius: 8px; color: white; cursor: pointer; }
    .btn-add:hover { background: #5568d3; }
    .btn-delete-all { background: #dc2626; padding: 12px 24px; border: none; border-radius: 8px; color: white; cursor: pointer; }
    .btn-delete-all:hover { background: #b91c1c; }
    
    .add-transaction-form { background: #252525; padding: 25px; border-radius: 8px; margin-bottom: 30px; display: none; }
    .add-transaction-form.show { display: block; }
    .form-title { color: #667eea; font-size: 1.3em; margin-bottom: 10px; }
    .form-desc { color: #aaa; margin-bottom: 20px; }
    
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
    .form-field { display: flex; flex-direction: column; }
    .form-field label { color: #ccc; margin-bottom: 8px; font-weight: 500; }
    .form-field input, .form-field select, .form-field textarea { 
        padding: 12px; background: #1a1a1a; border: 1px solid #333; color: #fff; border-radius: 6px; 
    }
    .form-field input:focus, .form-field select:focus, .form-field textarea:focus { 
        border-color: #667eea; outline: none; 
    }
    
    .checkbox-field { display: flex; align-items: center; gap: 10px; margin: 15px 0; }
    .checkbox-field input[type="checkbox"] { width: auto; }
    
    .form-actions { display: flex; gap: 10px; margin-top: 20px; }
    .btn-submit { background: #10b981; }
    .btn-submit:hover { background: #059669; }
    .btn-cancel { background: #6b7280; }
    .btn-cancel:hover { background: #4b5563; }
    
    .transactions-table { width: 100%; background: #252525; border-radius: 8px; overflow: hidden; }
    .table-header { background: #1a1a1a; }
    .table-header th { padding: 15px; text-align: left; color: #ccc; font-weight: 500; border-bottom: 1px solid #333; }
    .table-filters { background: #2a2a2a; }
    .table-filters td { padding: 10px; border-bottom: 1px solid #333; }
    .filter-input { width: 100%; padding: 8px; background: #1a1a1a; border: 1px solid #333; color: #fff; border-radius: 4px; }
    .filter-select { width: 100%; padding: 8px; background: #1a1a1a; border: 1px solid #333; color: #fff; border-radius: 4px; }
    
    .table-body tr { border-bottom: 1px solid #333; }
    .table-body tr:hover { background: #2a2a2a; }
    .table-body td { padding: 12px 15px; color: #fff; }
    
    .user-cell { display: flex; align-items: center; gap: 10px; cursor: pointer; }
    .user-avatar { width: 35px; height: 35px; border-radius: 50%; }
    .user-name { color: #fff; }
    
    .points-negative { color: #f87171; }
    .points-positive { color: #10b981; }
    
    .action-delete { color: #f87171; text-decoration: none; }
    .action-delete:hover { color: #dc2626; }
    
    .checkbox-display { width: 16px; height: 16px; border: 1px solid #666; border-radius: 3px; background: #1a1a1a; }
    .checkbox-display.checked { background: #10b981; border-color: #10b981; }
    .checkbox-display.checked::after { content: 'âœ“'; color: white; font-size: 12px; display: flex; justify-content: center; align-items: center; }
    
    .error-message { color: #f87171; margin: 10px 0; padding: 10px; background: #2d1b1b; border-radius: 6px; display: none; }
    .success-message { color: #10b981; margin: 10px 0; padding: 10px; background: #1b2d1b; border-radius: 6px; display: none; }
    
    .pagination { display: flex; justify-content: center; gap: 10px; margin-top: 20px; }
    .pagination button { padding: 8px 12px; background: #333; border: none; color: #fff; border-radius: 4px; cursor: pointer; }
    .pagination button:hover { background: #444; }
    .pagination button.active { background: #667eea; }
</style>
{% endblock %}

{% block content %}
<div class="transactions-container">
    <h2 class="transactions-header">Transactions</h2>
    <div class="transactions-desc">
        Every time a user earns or loses points, a transaction will be posted. You can manage these transactions here.
    </div>

    <!-- Setup Warning -->
    <div class="setup-warning" id="setupWarning" style="display: none;">
        <div>Please run the <a href="{% url 'tiktok_live:setup' %}" style="color: #fff; text-decoration: underline;">Setup</a> first to create a free TikFinity Account!</div>
    </div>

    <!-- Controls -->
    <div class="controls-section">
        <button class="btn-add" onclick="toggleAddTransaction()">
            <i class="fas fa-plus"></i> Add Transaction
        </button>
        <button class="btn-delete-all" onclick="confirmDeleteAll()">
            <i class="fas fa-trash"></i> Delete All Transactions
        </button>
    </div>

    <!-- Add Transaction Form -->
    <div class="add-transaction-form" id="addTransactionForm">
        <h3 class="form-title">Add Transaction</h3>
        <div class="form-desc">
            Enter the required info to post a transaction manually.<br>
            Hint: Use a negative value to withdraw points.
        </div>

        <form id="transactionForm">
            <div class="form-row">
                <div class="form-field">
                    <label for="transactionUser">User</label>
                    <select id="transactionUser" required>
                        <option value="">Select User...</option>
                        <option value="user1">@eyp.toru</option>
                        <option value="user2">@1881_altuneraras</option>
                        <option value="user3">@intikam161</option>
                    </select>
                </div>
                <div class="form-field">
                    <label for="transactionAmount" id="currencyLabel">Points</label>
                    <input type="number" id="transactionAmount" step="0.1" placeholder="Enter amount" required>
                </div>
            </div>
            
            <div class="form-field">
                <label for="transactionDescription">Description (optional)</label>
                <textarea id="transactionDescription" rows="3" placeholder="Transaction description"></textarea>
            </div>
            
            <div class="checkbox-field">
                <input type="checkbox" id="countToLevel">
                <label for="countToLevel">Count to Level</label>
            </div>

            <div class="error-message" id="formError"></div>
            <div class="success-message" id="formSuccess"></div>

            <div class="form-actions">
                <button type="submit" class="btn-add btn-submit">
                    <i class="fas fa-paper-plane"></i> Send
                </button>
                <button type="button" class="btn-add btn-cancel" onclick="cancelAddTransaction()">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </form>
    </div>

    <!-- Transactions Table -->
    <div class="transactions-table">
        <table style="width: 100%;">
            <thead class="table-header">
                <tr>
                    <th style="width: 100px;">Action</th>
                    <th>User</th>
                    <th>Points</th>
                    <th>Description</th>
                    <th>Counted to Level</th>
                    <th>Added Manually</th>
                    <th>Timestamp</th>
                </tr>
            </thead>
            <tbody class="table-filters">
                <tr>
                    <td></td>
                    <td><input type="text" class="filter-input" placeholder="Filter users..." id="filterUser"></td>
                    <td><input type="number" class="filter-input" placeholder="Filter points..." id="filterPoints"></td>
                    <td><input type="text" class="filter-input" placeholder="Filter description..." id="filterDescription"></td>
                    <td>
                        <select class="filter-select" id="filterCountedToLevel">
                            <option value="">All</option>
                            <option value="true">Yes</option>
                            <option value="false">No</option>
                        </select>
                    </td>
                    <td>
                        <select class="filter-select" id="filterManual">
                            <option value="">All</option>
                            <option value="true">Yes</option>
                            <option value="false">No</option>
                        </select>
                    </td>
                    <td><input type="date" class="filter-input" id="filterDate"></td>
                </tr>
            </tbody>
            <tbody class="table-body" id="transactionsTableBody">
                <!-- Sample transactions -->
                <tr>
                    <td><a href="#" class="action-delete" onclick="deleteTransaction(this)">Delete</a></td>
                    <td>
                        <div class="user-cell" onclick="openUserAudit('7566597314220082194')">
                            <img src="https://via.placeholder.com/35" class="user-avatar" onerror="this.src='https://via.placeholder.com/35'">
                            <span class="user-name">@eyp.toru</span>
                        </div>
                    </td>
                    <td><span class="points-negative">- 0.5</span></td>
                    <td>Halving 50%</td>
                    <td><div class="checkbox-display"></div></td>
                    <td><div class="checkbox-display"></div></td>
                    <td>11/17/2025, 11:13 PM</td>
                </tr>
                <tr>
                    <td><a href="#" class="action-delete" onclick="deleteTransaction(this)">Delete</a></td>
                    <td>
                        <div class="user-cell" onclick="openUserAudit('7565058468454368274')">
                            <img src="https://via.placeholder.com/35" class="user-avatar" onerror="this.src='https://via.placeholder.com/35'">
                            <span class="user-name">@1881_altuneraras</span>
                        </div>
                    </td>
                    <td><span class="points-negative">- 0.5</span></td>
                    <td>Halving 50%</td>
                    <td><div class="checkbox-display"></div></td>
                    <td><div class="checkbox-display"></div></td>
                    <td>11/17/2025, 11:13 PM</td>
                </tr>
                <tr>
                    <td><a href="#" class="action-delete" onclick="deleteTransaction(this)">Delete</a></td>
                    <td>
                        <div class="user-cell" onclick="openUserAudit('7515461382575621152')">
                            <img src="https://via.placeholder.com/35" class="user-avatar" onerror="this.src='https://via.placeholder.com/35'">
                            <span class="user-name">@hakanantep2727</span>
                        </div>
                    </td>
                    <td><span class="points-negative">- 344.5</span></td>
                    <td>Halving 50%</td>
                    <td><div class="checkbox-display"></div></td>
                    <td><div class="checkbox-display"></div></td>
                    <td>11/17/2025, 11:13 PM</td>
                </tr>
                <tr>
                    <td><a href="#" class="action-delete" onclick="deleteTransaction(this)">Delete</a></td>
                    <td>
                        <div class="user-cell" onclick="openUserAudit('7440509061751997495')">
                            <img src="https://via.placeholder.com/35" class="user-avatar" onerror="this.src='https://via.placeholder.com/35'">
                            <span class="user-name">@sercan.qydgn2</span>
                        </div>
                    </td>
                    <td><span class="points-negative">- 170</span></td>
                    <td>Halving 50%</td>
                    <td><div class="checkbox-display"></div></td>
                    <td><div class="checkbox-display"></div></td>
                    <td>11/17/2025, 11:13 PM</td>
                </tr>
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="pagination">
        <button onclick="changePage('prev')"><i class="fas fa-chevron-left"></i></button>
        <button class="active">1</button>
        <button onclick="changePage(2)">2</button>
        <button onclick="changePage(3)">3</button>
        <button onclick="changePage('next')"><i class="fas fa-chevron-right"></i></button>
    </div>
</div>

<script>
let currentPage = 1;
let totalPages = 3;

function toggleAddTransaction() {
    const form = document.getElementById('addTransactionForm');
    form.classList.toggle('show');
    if (form.classList.contains('show')) {
        document.getElementById('transactionUser').focus();
    }
}

function cancelAddTransaction() {
    document.getElementById('addTransactionForm').classList.remove('show');
    document.getElementById('transactionForm').reset();
    hideMessages();
}

function hideMessages() {
    document.getElementById('formError').style.display = 'none';
    document.getElementById('formSuccess').style.display = 'none';
}

function showError(message) {
    const errorEl = document.getElementById('formError');
    errorEl.textContent = message;
    errorEl.style.display = 'block';
    document.getElementById('formSuccess').style.display = 'none';
}

function showSuccess(message) {
    const successEl = document.getElementById('formSuccess');
    successEl.textContent = message;
    successEl.style.display = 'block';
    document.getElementById('formError').style.display = 'none';
}

document.getElementById('transactionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const user = document.getElementById('transactionUser').value;
    const amount = document.getElementById('transactionAmount').value;
    
    if (!user) {
        showError('Please select a user');
        return;
    }
    
    if (!amount) {
        showError('Please enter an amount');
        return;
    }
    
    // Simulate API call
    setTimeout(() => {
        showSuccess('Transaction added successfully!');
        addTransactionToTable();
        setTimeout(() => {
            cancelAddTransaction();
        }, 1500);
    }, 500);
});

function addTransactionToTable() {
    const tbody = document.getElementById('transactionsTableBody');
    const user = document.getElementById('transactionUser').value;
    const amount = parseFloat(document.getElementById('transactionAmount').value);
    const description = document.getElementById('transactionDescription').value || 'Manual transaction';
    const countToLevel = document.getElementById('countToLevel').checked;
    
    const row = document.createElement('tr');
    const pointsClass = amount >= 0 ? 'points-positive' : 'points-negative';
    const pointsSign = amount >= 0 ? '+' : '';
    
    row.innerHTML = `
        <td><a href="#" class="action-delete" onclick="deleteTransaction(this)">Delete</a></td>
        <td>
            <div class="user-cell">
                <img src="https://via.placeholder.com/35" class="user-avatar">
                <span class="user-name">${user}</span>
            </div>
        </td>
        <td><span class="${pointsClass}">${pointsSign} ${amount}</span></td>
        <td>${description}</td>
        <td><div class="checkbox-display ${countToLevel ? 'checked' : ''}"></div></td>
        <td><div class="checkbox-display checked"></div></td>
        <td>${new Date().toLocaleString()}</td>
    `;
    
    tbody.insertBefore(row, tbody.firstChild);
}

function deleteTransaction(element) {
    if (confirm('Are you sure you want to delete this transaction?')) {
        element.closest('tr').remove();
        showSuccess('Transaction deleted successfully!');
        setTimeout(() => hideMessages(), 2000);
    }
}

function confirmDeleteAll() {
    if (confirm('Are you sure you want to delete ALL transactions? This action cannot be undone.')) {
        document.getElementById('transactionsTableBody').innerHTML = '';
        showSuccess('All transactions deleted successfully!');
        setTimeout(() => hideMessages(), 2000);
    }
}

function openUserAudit(userId) {
    console.log('Opening user audit for:', userId);
    // Implement user audit functionality
}

function changePage(page) {
    if (page === 'prev' && currentPage > 1) {
        currentPage--;
    } else if (page === 'next' && currentPage < totalPages) {
        currentPage++;
    } else if (typeof page === 'number') {
        currentPage = page;
    }
    
    // Update pagination buttons
    document.querySelectorAll('.pagination button').forEach(btn => {
        btn.classList.remove('active');
    });
    document.querySelector(`.pagination button:nth-child(${currentPage + 1})`).classList.add('active');
    
    // Simulate loading new data
    console.log('Loading page:', currentPage);
}

// Filter functionality
document.getElementById('filterUser').addEventListener('input', filterTransactions);
document.getElementById('filterPoints').addEventListener('input', filterTransactions);
document.getElementById('filterDescription').addEventListener('input', filterTransactions);
document.getElementById('filterCountedToLevel').addEventListener('change', filterTransactions);
document.getElementById('filterManual').addEventListener('change', filterTransactions);
document.getElementById('filterDate').addEventListener('change', filterTransactions);

function filterTransactions() {
    const userFilter = document.getElementById('filterUser').value.toLowerCase();
    const pointsFilter = document.getElementById('filterPoints').value;
    const descFilter = document.getElementById('filterDescription').value.toLowerCase();
    const countedFilter = document.getElementById('filterCountedToLevel').value;
    const manualFilter = document.getElementById('filterManual').value;
    const dateFilter = document.getElementById('filterDate').value;
    
    const rows = document.querySelectorAll('#transactionsTableBody tr');
    
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        const userName = cells[1].textContent.toLowerCase();
        const points = cells[2].textContent;
        const description = cells[3].textContent.toLowerCase();
        
        let show = true;
        
        if (userFilter && !userName.includes(userFilter)) show = false;
        if (pointsFilter && !points.includes(pointsFilter)) show = false;
        if (descFilter && !description.includes(descFilter)) show = false;
        
        row.style.display = show ? '' : 'none';
    });
}

// Check connection status on load
document.addEventListener('DOMContentLoaded', function() {
    // Simulate checking connection status
    const isConnected = Math.random() > 0.5; // Random for demo
    
    if (!isConnected) {
        document.getElementById('setupWarning').style.display = 'block';
    }
});
</script>
{% endblock %}