{% extends 'tiktok_live/base.html' %}

{% block page_title %}Likeathon{% endblock %}

{% block extra_css %}
<style>
    .blueheading { color: #667eea; margin-bottom: 15px; }
    .noTopMarginHeader { margin-top: 0; }
    .greyBackgroundSection { background: #1a1a1a; padding: 30px; border-radius: 12px; margin-bottom: 20px; }
    .greyBackgroundSectionDynamicWidth { max-width: 600px; }
    .greyBackgroundSectionOverlayFix { margin-top: -20px; }
    .redNotification { background: #dc2626; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .redNotification .error a { color: #fff; text-decoration: underline; }
    .dx-field { margin-bottom: 20px; display: flex; align-items: center; }
    .dx-field-label { min-width: 200px; color: #ccc; font-weight: 500; }
    .dx-field-value { flex: 1; }
    .dx-fieldset { margin-bottom: 30px; }
    .checkbox { display: flex; align-items: center; gap: 10px; margin: 10px 0; }
    .checkbox input[type="checkbox"] { width: 18px; height: 18px; }
    .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; background: #667eea; color: white; display: inline-flex; align-items: center; gap: 8px; }
    .btn:hover { background: #5568d3; }
    .btn-danger { background: #dc2626; }
    .btn-danger:hover { background: #b91c1c; }
    .settings-container { display: flex; gap: 20px; }
    .settings-left { flex: 1; }
    .settings-right { width: 200px; }
    .slider-container { position: relative; width: 100%; height: 6px; background: #333; border-radius: 3px; margin: 10px 0; }
    .slider-track { height: 100%; background: #667eea; border-radius: 3px; position: relative; }
    .slider-handle { position: absolute; right: -10px; top: -7px; width: 20px; height: 20px; background: #667eea; border-radius: 50%; cursor: pointer; }
    .intensity-display { color: #888; font-size: 0.9em; margin-top: 5px; }
    .hint { color: #888; font-size: 0.9em; margin-left: 10px; }
    .overlay-iframe { width: 867px; height: 600px; border: 1px solid #4e4e4e; border-radius: 8px; }
</style>
{% endblock %}

{% block content %}
<div class="page pageenabled" data-pageid="likeathon">
    <h2 class="blueheading">Likeathon</h2>
    <div style="max-width: 700px;">
        Show the viewers who have sent the most likes (‚ù§Ô∏è taps on screen) in a ranking list and create a battle against time by activating the automatic reduction. This means that the score is reduced by X percent every 10 seconds and your viewers have to keep sending likes to keep their place at the top of the ranking!
    </div>

    <br>

    <div class="redNotification" style="display: none;">
        <div class="error">Please run the <a href="{% url 'tiktok_live:setup' %}">Setup</a> first to create a free TikFinity Account!</div>
    </div>

    <div class="settings-container">
        <div class="settings-left">
            <div class="greyBackgroundSection greyBackgroundSectionDynamicWidth" style="height: 210px;">
                <h3 class="blueheading noTopMarginHeader">Automatic Reduction</h3>
                <div class="dxForm">
                    <div class="form">
                        <div class="dx-fieldset">
                            <div class="dx-field">
                                <div class="dx-field-label">Enable reduction</div>
                                <div class="dx-field-value">
                                    <div class="checkbox">
                                        <input type="checkbox" id="checkboxLikeathonEnableAutomaticDecrease">
                                    </div>
                                    <div class="hint" id="likeathonHint1">üëà Make it more challenging</div>
                                </div>
                            </div>
                            <div class="dx-field">
                                <div class="dx-field-label">Intensity</div>
                                <div class="dx-field-value">
                                    <div class="slider-container" id="sliderLikeathonDecreaseSpeed">
                                        <div class="slider-track" style="width: 18.37%;">
                                            <div class="slider-handle" id="sliderHandle"></div>
                                        </div>
                                    </div>
                                    <div class="intensity-display" id="likeathonIntensityValue">Reduce score by 10% every 10 seconds.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="settings-right">
            <div class="greyBackgroundSection greyBackgroundSectionDynamicWidth" style="height: 210px; width: 200px;">
                <h3 class="blueheading noTopMarginHeader">Reset</h3>
                <br>
                <button id="buttonLikeathonReset" class="btn btn-danger" style="margin-left: 20px;">
                    Reset List
                </button>
            </div>
        </div>
    </div>

    <div class="greyBackgroundSection greyBackgroundSectionOverlayFix">
        <h3 class="blueheading noTopMarginHeader">Top Liker</h3>
        <div id="widgetToplikerLikeathon" data-widgetid="topliker">
            <div style="display: flex; gap: 5px; align-items: center; margin-bottom: 10px;">
                <input type="text" readonly style="width: 501px;" placeholder="Widget URL will appear here">
                <button class="btn">Copy URL</button>
                <button class="btn"><i class="fas fa-chevron-right"></i> Test</button>
                <button class="btn"><i class="fas fa-cog"></i> Customize</button>
            </div>
            <iframe src="https://tikfinity.zerody.one/widget/topliker?cid=2449591&preview=1" class="overlay-iframe"></iframe>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let reductionEnabled = false;
    let reductionIntensity = 10;
    let reductionInterval = null;

    const enableCheckbox = document.getElementById('checkboxLikeathonEnableAutomaticDecrease');
    const sliderHandle = document.getElementById('sliderHandle');
    const intensityDisplay = document.getElementById('likeathonIntensityValue');
    const resetButton = document.getElementById('buttonLikeathonReset');

    // Enable/disable automatic reduction
    enableCheckbox.addEventListener('change', function() {
        reductionEnabled = this.checked;
        
        if (reductionEnabled) {
            startReduction();
        } else {
            stopReduction();
        }
    });

    // Slider functionality
    let isDragging = false;
    
    sliderHandle.addEventListener('mousedown', function(e) {
        isDragging = true;
        e.preventDefault();
    });

    document.addEventListener('mousemove', function(e) {
        if (!isDragging) return;
        
        const slider = document.getElementById('sliderLikeathonDecreaseSpeed');
        const rect = slider.getBoundingClientRect();
        const percentage = Math.max(0, Math.min(100, ((e.clientX - rect.left) / rect.width) * 100));
        
        // Convert percentage to intensity value (1-50)
        reductionIntensity = Math.round((percentage / 100) * 49) + 1;
        
        // Update slider visual
        const track = slider.querySelector('.slider-track');
        track.style.width = percentage + '%';
        
        // Update intensity display
        updateIntensityDisplay();
    });

    document.addEventListener('mouseup', function() {
        isDragging = false;
    });

    function updateIntensityDisplay() {
        intensityDisplay.textContent = `Reduce score by ${reductionIntensity}% every 10 seconds.`;
    }

    function startReduction() {
        if (reductionInterval) return;
        
        reductionInterval = setInterval(() => {
            console.log(`Reducing all scores by ${reductionIntensity}%`);
            // Here you would implement the actual score reduction logic
        }, 10000); // Every 10 seconds
        
        console.log('Automatic reduction started');
    }

    function stopReduction() {
        if (reductionInterval) {
            clearInterval(reductionInterval);
            reductionInterval = null;
        }
        
        console.log('Automatic reduction stopped');
    }

    // Reset button
    resetButton.addEventListener('click', function() {
        if (confirm('Are you sure you want to reset the likeathon list? This will clear all current scores.')) {
            console.log('Likeathon list reset');
            alert('Likeathon list has been reset successfully!');
        }
    });

    // Copy URL functionality
    document.querySelector('.btn').addEventListener('click', function() {
        if (this.textContent === 'Copy URL') {
            navigator.clipboard.writeText('https://tikfinity.zerody.one/widget/topliker?cid=2449591');
            this.textContent = 'Copied!';
            setTimeout(() => {
                this.textContent = 'Copy URL';
            }, 2000);
        }
    });

    // Test functionality
    document.querySelectorAll('.btn').forEach(btn => {
        if (btn.innerHTML.includes('Test')) {
            btn.addEventListener('click', function() {
                console.log('Testing Top Liker widget');
                alert('Test mode activated for Top Liker widget');
            });
        }
    });

    // Initialize display
    updateIntensityDisplay();
</script>
{% endblock %}